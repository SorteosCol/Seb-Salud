<!DOCTYPE html>
<html lang="es" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Seb Salud - Plataforma de Gestión (Firebase conectado)</title>

  <!-- Tailwind + Iconos -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>

  <style>
    :root{
      --color-primary-400: 165 180 252; /* indigo-300 */
      --color-primary-500: 129 140 248; /* indigo-400 */
      --color-primary-600: 79 70 229;   /* indigo-600 */
      --color-primary-700: 67 56 202;   /* indigo-700 */
    }
    body{font-family:'Inter',sans-serif}
    .bg-primary-600{background:rgb(var(--color-primary-600))}
    .bg-primary-700{background:rgb(var(--color-primary-700))}
    .text-primary-500{color:rgb(var(--color-primary-500))}
    .text-primary-600{color:rgb(var(--color-primary-600))}
    .hover\:bg-primary-700:hover{background:rgb(var(--color-primary-700))}
    .sidebar{transition:transform .3s}
    .modal{transition:opacity .25s}
    .modal-content{transition:transform .25s}
    .content-section{display:none}
    .content-section.active{display:block;animation:fadeIn .5s ease}
    @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
    ::-webkit-scrollbar{width:8px;height:8px}
    ::-webkit-scrollbar-thumb{background:#94a3b8;border-radius:10px}
    ::-webkit-scrollbar-thumb:hover{background:#64748b}
  </style>
</head>
<body class="bg-slate-50 text-slate-800 antialiased">

<!-- ====== Banner de ayuda despliegue ====== -->
<div id="deploy-hint" class="hidden bg-amber-50 text-amber-900 border border-amber-200 px-4 py-3 text-sm">
  <b>Nota:</b> Si publicaste en <code>github.io</code> y no pasa del login:
  habilita <b>Email/Password</b> en Firebase Auth, agrega tu dominio en <b>Authorized domains</b>,
  y pega tus credenciales en <code>window.__FIREBASE_CONFIG__</code>. Si falla, entrarás en <b>modo demo (anónimo)</b>.
</div>

<!-- ====== Auth ====== -->
<div id="auth-container" class="min-h-screen flex items-center justify-center p-4">
  <div class="w-full max-w-md bg-white rounded-xl shadow-lg p-8 space-y-6">
    <div class="text-center">
      <div class="flex items-center justify-center mb-4">
        <i data-lucide="shield-check" class="h-10 w-10 text-primary-500"></i>
        <span class="ml-3 text-3xl font-extrabold">Seb Salud</span>
      </div>
      <h2 id="auth-title" class="text-2xl font-bold">Inicia sesión</h2>
      <p id="auth-subtitle" class="text-slate-500">Usa tu correo y contraseña</p>
    </div>

    <form id="login-form" class="space-y-4">
      <div>
        <label class="text-sm font-medium">Correo</label>
        <input id="login-email" type="email" required class="w-full px-4 py-2 mt-1 border border-slate-300 rounded-lg focus:ring-primary-600 focus:border-primary-600" placeholder="tu@email.com"/>
      </div>
      <div>
        <label class="text-sm font-medium">Contraseña</label>
        <input id="login-password" type="password" required class="w-full px-4 py-2 mt-1 border border-slate-300 rounded-lg focus:ring-primary-600 focus:border-primary-600" placeholder="••••••••"/>
      </div>
      <button class="w-full py-3 px-4 text-white bg-primary-600 rounded-lg hover:bg-primary-700 font-semibold">Ingresar</button>
      <p class="text-center text-sm text-slate-500">
        ¿No tienes cuenta?
        <a href="#" id="goto-register" class="text-primary-600 underline">Crear una</a>
      </p>
    </form>

    <form id="register-form" class="space-y-4 hidden">
      <div>
        <label class="text-sm font-medium">Correo</label>
        <input id="register-email" type="email" required class="w-full px-4 py-2 mt-1 border border-slate-300 rounded-lg focus:ring-primary-600 focus:border-primary-600" placeholder="tu@email.com"/>
      </div>
      <div>
        <label class="text-sm font-medium">Contraseña</label>
        <input id="register-password" type="password" required class="w-full px-4 py-2 mt-1 border border-slate-300 rounded-lg focus:ring-primary-600 focus:border-primary-600" placeholder="Mínimo 6 caracteres"/>
      </div>
      <button class="w-full py-3 px-4 text-white bg-primary-600 rounded-lg hover:bg-primary-700 font-semibold">Crear cuenta</button>
      <p class="text-center text-sm text-slate-500">
        ¿Ya tienes cuenta?
        <a href="#" id="goto-login" class="text-primary-600 underline">Inicia sesión</a>
      </p>
    </form>

    <div id="auth-error" class="text-center text-sm text-red-600 font-medium"></div>
    <div id="auth-info" class="text-center text-xs text-slate-500"></div>
  </div>
</div>

<!-- ====== App ====== -->
<div id="app-container" class="hidden">
  <!-- Toast -->
  <div id="toast" class="fixed top-5 right-5 z-[100] bg-slate-900 text-white py-2 px-4 rounded-lg shadow-xl opacity-0 translate-y-2 transition-all duration-300">
    <span id="toast-message"></span>
  </div>

  <div class="flex h-screen overflow-hidden">
    <!-- Sidebar -->
    <aside id="sidebar" class="sidebar bg-slate-900 text-slate-200 w-64 fixed inset-y-0 left-0 transform -translate-x-full md:translate-x-0 z-50 flex flex-col">
      <div class="flex items-center justify-center h-20 border-b border-slate-700">
        <i data-lucide="shield-check" class="h-8 w-8 text-primary-500"></i>
        <span class="ml-3 text-xl font-bold">Seb Salud</span>
      </div>
      <nav id="main-nav" class="flex-1 px-4 py-6 space-y-2 overflow-y-auto"></nav>
      <div class="px-4 py-4 border-t border-slate-700">
        <div id="user-info" class="mb-4">
          <p id="user-display-name" class="font-semibold truncate"></p>
          <p id="user-display-role" class="text-xs text-primary-500 uppercase"></p>
        </div>
        <button id="logout-btn" class="w-full flex items-center justify-center py-2 px-4 rounded-lg bg-slate-700 hover:bg-red-600/60 text-sm">
          <i data-lucide="log-out" class="w-4 h-4 mr-2"></i> Cerrar sesión
        </button>
      </div>
    </aside>

    <!-- Main -->
    <div class="flex-1 flex flex-col md:ml-64">
      <header class="bg-white/70 backdrop-blur-sm shadow-sm flex items-center justify-between p-4 sticky top-0 z-20">
        <div class="flex items-center">
          <h1 id="header-title" class="text-xl font-semibold text-slate-700">Dashboard</h1>
        </div>
      </header>

      <main id="main-content" class="flex-1 p-4 sm:p-6 lg:p-8 overflow-y-auto pb-24 md:pb-8">
        <section id="dashboard" class="content-section"></section>
        <section id="afiliados" class="content-section"></section>
        <section id="asesores" class="content-section"></section>
        <section id="planes" class="content-section"></section>
        <section id="usuarios" class="content-section"></section>
        <section id="config" class="content-section"></section>
      </main>
    </div>
  </div>
</div>

<!-- ====== Modales mínimos (CRUD) ====== -->
<!-- Afiliado -->
<div id="affiliate-modal" class="modal fixed inset-0 bg-black/70 flex items-center justify-center p-4 opacity-0 pointer-events-none z-[60] hidden">
  <div class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-3xl transform scale-95">
    <div class="flex justify-between items-center p-5 border-b sticky top-0 bg-white z-10">
      <h2 id="affiliate-modal-title" class="text-2xl font-bold">Nuevo Afiliado</h2>
      <button data-close="affiliate-modal" class="text-gray-400 hover:text-gray-600 text-3xl" aria-label="Cerrar">&times;</button>
    </div>
    <form id="affiliate-form" class="p-6 grid grid-cols-1 md:grid-cols-2 gap-4">
      <input type="hidden" id="affiliate-id-hidden"/>
      <input id="affiliate-name" class="p-2 border rounded-lg" placeholder="Nombre completo" required/>
      <input id="affiliate-document" class="p-2 border rounded-lg" placeholder="Documento" required/>
      <input id="affiliate-email" type="email" class="p-2 border rounded-lg" placeholder="Correo" required/>
      <input id="affiliate-phone" class="p-2 border rounded-lg" placeholder="Teléfono"/>
      <input id="affiliate-address" class="md:col-span-2 p-2 border rounded-lg" placeholder="Dirección"/>
      <div>
        <label class="text-sm font-medium">Plan</label>
        <select id="affiliate-plan" class="w-full p-2 border rounded-lg"></select>
      </div>
      <div>
        <label class="text-sm font-medium">Asesor</label>
        <select id="affiliate-advisor" class="w-full p-2 border rounded-lg"></select>
      </div>
      <div>
        <label class="text-sm font-medium">Estado</label>
        <select id="affiliate-status" class="w-full p-2 border rounded-lg">
          <option>Activo</option><option>Pendiente</option><option>Inactivo</option>
        </select>
      </div>
      <textarea id="affiliate-notes" class="md:col-span-2 p-2 border rounded-lg" placeholder="Notas..."></textarea>
      <div class="md:col-span-2 pt-4 border-t flex justify-end">
        <button class="bg-primary-600 hover:bg-primary-700 text-white font-bold py-2 px-6 rounded-lg">Guardar</button>
      </div>
    </form>
  </div>
</div>

<!-- Asesor -->
<div id="advisor-modal" class="modal fixed inset-0 bg-black/70 flex items-center justify-center p-4 opacity-0 pointer-events-none z-[60] hidden">
  <div class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-md transform scale-95">
    <div class="flex justify-between items-center p-5 border-b">
      <h2 id="advisor-modal-title" class="text-2xl font-bold">Nuevo Asesor</h2>
      <button data-close="advisor-modal" class="text-gray-400 hover:text-gray-600 text-3xl">&times;</button>
    </div>
    <form id="advisor-form" class="p-6 space-y-4">
      <input type="hidden" id="advisor-id-hidden"/>
      <input id="advisor-name" class="w-full p-2 border rounded-lg" placeholder="Nombre completo" required/>
      <input id="advisor-commission" type="number" min="0" max="100" class="w-full p-2 border rounded-lg" placeholder="Comisión (%)" required/>
      <div class="pt-4 border-t flex justify-end">
        <button class="bg-primary-600 hover:bg-primary-700 text-white font-bold py-2 px-6 rounded-lg">Guardar</button>
      </div>
    </form>
  </div>
</div>

<!-- Plan -->
<div id="plan-modal" class="modal fixed inset-0 bg-black/70 flex items-center justify-center p-4 opacity-0 pointer-events-none z-[60] hidden">
  <div class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-md transform scale-95">
    <div class="flex justify-between items-center p-5 border-b">
      <h2 id="plan-modal-title" class="text-2xl font-bold">Nuevo Plan</h2>
      <button data-close="plan-modal" class="text-gray-400 hover:text-gray-600 text-3xl">&times;</button>
    </div>
    <form id="plan-form" class="p-6 space-y-4">
      <input type="hidden" id="plan-id-hidden"/>
      <input id="plan-name" class="w-full p-2 border rounded-lg" placeholder="Nombre del plan" required/>
      <input id="plan-price" type="number" class="w-full p-2 border rounded-lg" placeholder="Precio mensual" required/>
      <textarea id="plan-features" class="w-full p-2 border rounded-lg h-28" placeholder="Una por línea..." required></textarea>
      <div class="pt-4 border-t flex justify-end">
        <button class="bg-primary-600 hover:bg-primary-700 text-white font-bold py-2 px-6 rounded-lg">Guardar</button>
      </div>
    </form>
  </div>
</div>

<!-- Usuario App -->
<div id="user-modal" class="modal fixed inset-0 bg-black/70 flex items-center justify-center p-4 opacity-0 pointer-events-none z-[60] hidden">
  <div class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-md transform scale-95">
    <div class="flex justify-between items-center p-5 border-b">
      <h2 id="user-modal-title" class="text-2xl font-bold">Nuevo Usuario (App)</h2>
      <button data-close="user-modal" class="text-gray-400 hover:text-gray-600 text-3xl">&times;</button>
    </div>
    <form id="user-form" class="p-6 space-y-4">
      <input type="hidden" id="user-id-hidden"/>
      <input id="user-email" type="email" class="w-full p-2 border rounded-lg" placeholder="Correo" required/>
      <input id="user-password" type="password" class="w-full p-2 border rounded-lg" placeholder="Contraseña (dejar vacío para no cambiar)"/>
      <div>
        <label class="text-sm font-medium">Rol</label>
        <select id="user-role" class="w-full p-2 border rounded-lg">
          <option value="admin">Admin</option>
          <option value="asesor">Asesor</option>
          <option value="afiliado">Afiliado</option>
        </select>
      </div>
      <div>
        <label class="text-sm font-medium">Vincular a</label>
        <select id="user-link" class="w-full p-2 border rounded-lg"></select>
      </div>
      <div class="pt-4 border-t flex justify-end">
        <button class="bg-primary-600 hover:bg-primary-700 text-white font-bold py-2 px-6 rounded-lg">Guardar</button>
      </div>
    </form>
  </div>
</div>

<!-- ================= Firebase y App (type=module) ================= -->
<script>
  /* Pega aquí tus credenciales reales para producción */
  window.__FIREBASE_CONFIG__ = {
  apiKey: "AIzaSyDS4VDnwGia2ZUe3o81rqLe-oEu_pVCUHc",
  authDomain: "seb-salud.firebaseapp.com",
  projectId: "seb-salud",
  storageBucket: "seb-salud.firebasestorage.app",
  messagingSenderId: "1094873327284",
  appId: "1:1094873327284:web:001e70e84c2de45389d9e1",
  measurementId: "G-EJCS9FYWHK"
};
</script>

<script type="module">
  // ===== Firebase SDK (modular) =====
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getAuth, onAuthStateChanged, signInWithEmailAndPassword,
    createUserWithEmailAndPassword, signOut, updatePassword,
    setPersistence, browserLocalPersistence, connectAuthEmulator,
    signInAnonymously
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import {
    getFirestore, collection, doc, getDoc, getDocs,
    setDoc, addDoc, updateDoc, deleteDoc, serverTimestamp,
    query, orderBy, where, connectFirestoreEmulator
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  // ===== Flags =====
  const AUTO_FALLBACK_ANON = true;      // entra sí o sí con anónimo si falla login/registro
  const PROMOTE_FIRST_ADMIN = true;     // si no hay admin, el primero autenticado será admin

  // ===== Utilidades UI =====
  const $ = (sel) => document.querySelector(sel);
  const $$ = (sel) => document.querySelectorAll(sel);
  const show = (el) => el && el.classList.remove('hidden','opacity-0','pointer-events-none');
  const hide = (el) => el && el.classList.add('hidden');
  const openModal = (id)=>{ const m=$(`#${id}`); if(!m) return; show(m); m.classList.remove('opacity-0','pointer-events-none'); m.querySelector('.modal-content')?.classList.remove('scale-95'); }
  const closeModal = (id)=>{ const m=$(`#${id}`); if(!m) return; m.classList.add('opacity-0'); m.querySelector('.modal-content')?.classList.add('scale-95'); setTimeout(()=>m.classList.add('pointer-events-none','hidden'),200); }
  const toast = (msg, ok=true)=>{
    const t=$("#toast"), span=$("#toast-message");
    span.textContent=msg;
    t.classList.remove('opacity-0','translate-y-2');
    t.classList.toggle('bg-slate-900', ok);
    t.classList.toggle('bg-red-600', !ok);
    setTimeout(()=>t.classList.add('opacity-0','translate-y-2'),2400);
  };

  // ===== Firebase Init + Emulators =====
  const CONFIG = window.__FIREBASE_CONFIG__;
  const useEmu = new URLSearchParams(location.search).has('emu') || Object.values(CONFIG).some(v => String(v||'').startsWith('TU_'));
  const app = initializeApp(CONFIG);
  const auth = getAuth(app);
  const db = getFirestore(app);
  await setPersistence(auth, browserLocalPersistence);

  if(useEmu){
    try{
      connectAuthEmulator(auth, "http://127.0.0.1:9099");
      connectFirestoreEmulator(db, "127.0.0.1", 8080);
      console.log("✅ Usando Firebase Emulator Suite");
    }catch(e){ console.warn("Emulators no disponibles:", e); }
  }

  // Hints para GitHub Pages
  const host = location.hostname || "";
  if(host.endsWith("github.io")) show($("#deploy-hint"));

  // ===== Colecciones =====
  const colUsersApp   = () => collection(db, "usersApp");
  const colAffiliates = () => collection(db, "affiliates");
  const colAdvisors   = () => collection(db, "advisors");
  const colPlans      = () => collection(db, "healthPlans");
  const colSettings   = () => collection(db, "settings");

  // Estado
  let currentUser = null;
  let usersApp = [], affiliates = [], advisors = [], plans = [], settings = {};
  let anonTried = false;

  // ===== Auth UI =====
  const authContainer = $("#auth-container");
  const appContainer  = $("#app-container");
  const gotoRegister  = $("#goto-register");
  const gotoLogin     = $("#goto-login");
  const loginForm     = $("#login-form");
  const registerForm  = $("#register-form");
  const authError     = $("#auth-error");
  const authInfo      = $("#auth-info");

  gotoRegister?.addEventListener("click", e=>{
    e.preventDefault();
    hide(loginForm); show(registerForm);
    $("#auth-title").textContent = "Crea tu cuenta";
    $("#auth-subtitle").textContent = "Regístrate para empezar";
  });

  gotoLogin?.addEventListener("click", e=>{
    e.preventDefault();
    hide(registerForm); show(loginForm);
    $("#auth-title").textContent = "Inicia sesión";
    $("#auth-subtitle").textContent = "Usa tu correo y contraseña";
  });

  loginForm?.addEventListener("submit", async (e)=>{
    e.preventDefault(); authError.textContent=""; authInfo.textContent="";
    const email = $("#login-email").value.trim();
    const pass  = $("#login-password").value.trim();
    try{
      await signInWithEmailAndPassword(auth, email, pass);
      toast("Bienvenido 👋");
    }catch(err){
      handleAuthError(err, "login");
    }
  });

  registerForm?.addEventListener("submit", async (e)=>{
    e.preventDefault(); authError.textContent=""; authInfo.textContent="";
    const email = $("#register-email").value.trim();
    const pass  = $("#register-password").value.trim();
    try{
      const { user } = await createUserWithEmailAndPassword(auth, email, pass);
      const hasAdmins = (await getDocs(query(colUsersApp(), where("role","==","admin")))).size > 0;
      await setDoc(doc(colUsersApp(), user.uid), { uid:user.uid, email, role: hasAdmins ? "afiliado" : "admin", appDataId: null });
      toast("Cuenta creada ✅");
    }catch(err){
      handleAuthError(err, "register");
    }
  });

  function hintFor(errorCode){
    if(errorCode.includes("operation-not-allowed")) return "Habilita Email/Password en Firebase Console → Authentication → Sign-in method.";
    if(errorCode.includes("invalid-api-key")) return "Revisa tu firebaseConfig (API key/domains).";
    if(errorCode.includes("network-request-failed")) return "Problema de red/CORS. Verifica dominio autorizado y conexión.";
    if(errorCode.includes("unauthorized-domain")) return "Agrega este dominio en Authorized domains (Firebase Auth).";
    return "";
  }

  async function fallBackAnon(){
    if(!AUTO_FALLBACK_ANON) return false;
    if(anonTried) return false;
    anonTried = true;
    try{
      await signInAnonymously(auth);
      authInfo.textContent = "Entraste en modo demo (anónimo). Configura Auth para login real.";
      toast("Modo demo activo (sesión anónima)");
      return true;
    }catch(e){
      console.warn("Anon sign-in failed:", e);
      return false;
    }
  }

  function handleAuthError(err, ctx){
    console.error(`[${ctx}]`, err);
    const code = err?.code || "auth/unknown";
    const msgMap = {
      "auth/invalid-credential": "Credenciales inválidas.",
      "auth/user-not-found": "Usuario no encontrado.",
      "auth/wrong-password": "Contraseña incorrecta.",
      "auth/email-already-in-use": "El correo ya está registrado.",
      "auth/weak-password": "La contraseña es muy débil.",
    };
    const msg = msgMap[code] || `Error de autenticación (${code}).`;
    authError.textContent = msg + " " + hintFor(code);

    // Fallback automático
    fallBackAnon();
  }

  $("#logout-btn")?.addEventListener("click", ()=> signOut(auth));

  onAuthStateChanged(auth, async (user)=>{
    if(user){
      let snap = await getDoc(doc(colUsersApp(), user.uid));
      if(!snap.exists()){
        await setDoc(doc(colUsersApp(), user.uid), {
          uid:user.uid, email:user.email || null, role:"afiliado", appDataId:null, createdAt: serverTimestamp()
        });
        snap = await getDoc(doc(colUsersApp(), user.uid));
      }
      currentUser = { ...snap.data(), authUser:user };

      // Seed admin si no existe
      if(PROMOTE_FIRST_ADMIN){
        const adminsCount = (await getDocs(query(colUsersApp(), where("role","==","admin")))).size;
        if(adminsCount === 0){
          await updateDoc(doc(colUsersApp(), user.uid), { role:"admin" });
          currentUser.role = "admin";
          toast("Se configuró este usuario como ADMIN (primer usuario).");
        }
      }

      await bootstrapData();
      renderAppForRole();
      hide(authContainer); show(appContainer);
    }else{
      currentUser = null;
      show(authContainer); hide(appContainer);
      ["affiliate-modal","advisor-modal","plan-modal","user-modal"].forEach(id=>hide($(`#${id}`)));
    }
    lucide.createIcons();
  });

  // ===== Carga inicial de datos =====
  async function bootstrapData(){
    [affiliates, advisors, plans] = await Promise.all([loadAffiliates(), loadAdvisors(), loadPlans()]);
    settings = await loadSettings();
    usersApp = await loadUsersApp();
  }
  async function loadUsersApp(){ const qs = await getDocs(colUsersApp()); return qs.docs.map(d=>d.data()); }
  async function loadAffiliates(){
    const qs = await getDocs(query(colAffiliates(), orderBy("createdAt","desc")));
    return qs.docs.map(d=>({ id:d.id, ...d.data() }));
  }
  async function loadAdvisors(){
    const qs = await getDocs(query(colAdvisors(), orderBy("createdAt","desc")));
    return qs.docs.map(d=>({ id:d.id, ...d.data() }));
  }
  async function loadPlans(){
    const qs = await getDocs(query(colPlans(), orderBy("createdAt","desc")));
    const arr = qs.docs.map(d=>({ id:d.id, ...d.data() }));
    if(arr.length===0){
      const seed = [
        {name:"PAC Básico", price:65000, features:"3 especialidades\nAtención domiciliaria"},
        {name:"MP Clásico", price:195000, features:"10+ especialidades\nHabitación individual"},
        {name:"MP Global", price:320000, features:"Cobertura internacional\nAsistencia en viaje"}
      ];
      for(const p of seed){ await addDoc(colPlans(), {...p, createdAt:serverTimestamp()}); }
      return loadPlans();
    }
    return arr;
  }
  async function loadSettings(){
    const qs = await getDocs(colSettings());
    const obj = {}; qs.forEach(d=>{ obj[d.id]=d.data(); });
    return obj;
  }

  // ===== Navegación por rol =====
  function renderAppForRole(){
    const nav = $("#main-nav");
    const role = currentUser.role || "afiliado";
    const itemsByRole = {
      admin:   [{id:"dashboard",icon:"layout-dashboard",text:"Dashboard"},{id:"afiliados",icon:"users",text:"Afiliados"},{id:"asesores",icon:"briefcase",text:"Asesores"},{id:"planes",icon:"shield-plus",text:"Planes"},{id:"usuarios",icon:"user-cog",text:"Usuarios"},{id:"config",icon:"settings",text:"Configuración"}],
      asesor:  [{id:"dashboard",icon:"layout-dashboard",text:"Dashboard"},{id:"afiliados",icon:"users",text:"Mis Afiliados"}],
      afiliado:[{id:"dashboard",icon:"layout-dashboard",text:"Mi Estado"}]
    };
    nav.innerHTML = itemsByRole[role].map(x=>(
      `<a href="#" data-target="${x.id}" class="nav-link flex items-center py-2.5 px-4 rounded-lg hover:bg-slate-800/60">
        <i data-lucide="${x.icon}" class="w-5 h-5 mr-3"></i>${x.text}
       </a>`
    )).join("");
    $$("#main-nav .nav-link").forEach(a=>{
      a.addEventListener("click", (e)=>{
        e.preventDefault();
        const target=a.getAttribute("data-target");
        showSection(target);
      });
    });

    $("#user-display-name").textContent = currentUser.email || currentUser.uid;
    $("#user-display-role").textContent = (currentUser.role||"afiliado").toUpperCase();

    showSection("dashboard");
  }

  function showSection(id){
    $$(".content-section").forEach(s=>s.classList.remove("active"));
    $(`#${id}`)?.classList.add("active");
    if(id==="dashboard") renderDashboard();
    if(id==="afiliados") renderAffiliates();
    if(id==="asesores") renderAdvisors();
    if(id==="planes")   renderPlans();
    if(id==="usuarios") renderUsers();
    if(id==="config")   renderConfig();
    $("#header-title").textContent = capitalize(id);
    lucide.createIcons();
  }

  // ===== Dashboard =====
  function renderDashboard(){
    const el = $("#dashboard");
    const mine = currentUser.role==="asesor"
      ? affiliates.filter(a=>a.advisorId===currentUser.appDataId)
      : affiliates;

    const activos = mine.filter(a=>a.status==="Activo").length;
    const total   = mine.length;
    const estimado = mine.reduce((s,a)=>{
      const p=plans.find(p=>p.id===a.planId);
      return s+(p?Number(p.price||0):0);
    },0);

    el.innerHTML = `
      <h2 class="text-2xl font-bold mb-6">Resumen</h2>
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
        <div class="bg-white p-5 rounded-xl shadow">
          <p class="text-sm text-slate-500 uppercase">Afiliados</p>
          <p class="text-3xl font-extrabold mt-2">${total}</p>
        </div>
        <div class="bg-white p-5 rounded-xl shadow">
          <p class="text-sm text-slate-500 uppercase">Activos</p>
          <p class="text-3xl font-extrabold mt-2 text-green-600">${activos}</p>
        </div>
        <div class="bg-white p-5 rounded-xl shadow">
          <p class="text-sm text-slate-500 uppercase">Ingreso mensual estimado</p>
          <p class="text-3xl font-extrabold mt-2 text-primary-600">${formatCurrency(estimado)}</p>
        </div>
      </div>
    `;
  }

  // ===== Afiliados =====
  function renderAffiliates(){
    const el = $("#afiliados");
    const canEdit = currentUser.role!=="afiliado";
    el.innerHTML = `
      <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
        <h2 class="text-2xl font-bold">Afiliados</h2>
        ${canEdit ? `<button id="add-affiliate-btn" class="bg-primary-600 hover:bg-primary-700 text-white font-bold py-2 px-4 rounded-lg shadow flex items-center">
          <i data-lucide="plus" class="w-5 h-5 mr-2"></i> Nuevo Afiliado
        </button>` : ""}
      </div>
      <div class="bg-white rounded-xl shadow overflow-hidden">
        <table class="w-full text-sm">
          <thead class="bg-slate-50 text-slate-600 text-xs uppercase">
            <tr>
              <th class="text-left p-3">Nombre</th>
              <th class="text-left p-3">Documento</th>
              <th class="text-left p-3">Plan</th>
              <th class="text-left p-3">Asesor</th>
              <th class="text-left p-3">Estado</th>
              ${canEdit?`<th class="text-right p-3">Acciones</th>`:""}
            </tr>
          </thead>
          <tbody id="affiliates-tbody" class="divide-y"></tbody>
        </table>
      </div>
    `;

    $("#add-affiliate-btn")?.addEventListener("click", ()=>{
      resetAffiliateForm();
      openModal("affiliate-modal");
    });

    drawAffiliatesRows();
    lucide.createIcons();
  }

  function drawAffiliatesRows(){
    const tbody = $("#affiliates-tbody");
    const canEdit = currentUser.role!=="afiliado";
    if(!affiliates.length){
      tbody.innerHTML = `<tr><td colspan="${canEdit?6:5}" class="p-4 text-center text-slate-500">Sin afiliados</td></tr>`;
      return;
    }
    tbody.innerHTML = affiliates.map(a=>{
      const plan = plans.find(p=>p.id===a.planId);
      const adv  = advisors.find(v=>v.id===a.advisorId);
      return `<tr>
        <td class="p-3">${a.name||""}</td>
        <td class="p-3">${a.document||""}</td>
        <td class="p-3">${plan?plan.name:"—"}</td>
        <td class="p-3">${adv?adv.name:"—"}</td>
        <td class="p-3"><span class="px-2 py-1 rounded-full text-xs ${a.status==="Activo"?"bg-green-100 text-green-700":a.status==="Pendiente"?"bg-yellow-100 text-yellow-700":"bg-slate-200 text-slate-700"}">${a.status||"—"}</span></td>
        ${canEdit?`
        <td class="p-3 text-right">
          <button data-edit="${a.id}" class="inline-flex items-center p-2 text-slate-500 hover:text-primary-600 rounded-full" title="Editar">
            <i data-lucide="pencil" class="h-4 w-4"></i>
          </button>
          <button data-del="${a.id}" class="inline-flex items-center p-2 text-slate-500 hover:text-red-600 rounded-full" title="Eliminar">
            <i data-lucide="trash-2" class="h-4 w-4"></i>
          </button>
        </td>`:""}
      </tr>`;
    }).join("");

    $$('[data-edit]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const id = btn.getAttribute('data-edit');
        const a = affiliates.find(x=>x.id===id);
        if(!a) return;
        fillAffiliateForm(a);
        openModal("affiliate-modal");
      });
    });
    $$('[data-del]').forEach(btn=>{
      btn.addEventListener('click', async ()=>{
        const id = btn.getAttribute('data-del');
        await deleteDoc(doc(colAffiliates(), id));
        affiliates = affiliates.filter(x=>x.id!==id);
        drawAffiliatesRows(); toast("Afiliado eliminado");
      });
    });
  }

  function resetAffiliateForm(){
    $("#affiliate-id-hidden").value="";
    $("#affiliate-name").value="";
    $("#affiliate-document").value="";
    $("#affiliate-email").value="";
    $("#affiliate-phone").value="";
    $("#affiliate-address").value="";
    $("#affiliate-notes").value="";
    const planSel = $("#affiliate-plan");
    planSel.innerHTML = plans.map(p=>`<option value="${p.id}">${p.name}</option>`).join("");
    const advSel = $("#affiliate-advisor");
    advSel.innerHTML = advisors.map(v=>`<option value="${v.id}">${v.name}</option>`).join("");
  }
  function fillAffiliateForm(a){
    resetAffiliateForm();
    $("#affiliate-id-hidden").value=a.id;
    $("#affiliate-name").value=a.name||"";
    $("#affiliate-document").value=a.document||"";
    $("#affiliate-email").value=a.email||"";
    $("#affiliate-phone").value=a.phone||"";
    $("#affiliate-address").value=a.address||"";
    $("#affiliate-plan").value=a.planId||"";
    $("#affiliate-advisor").value=a.advisorId||"";
    $("#affiliate-status").value=a.status||"Activo";
    $("#affiliate-notes").value=a.notes||"";
  }
  $("#affiliate-form")?.addEventListener("submit", async (e)=>{
    e.preventDefault();
    const payload = {
      name: $("#affiliate-name").value.trim(),
      document: $("#affiliate-document").value.trim(),
      email: $("#affiliate-email").value.trim(),
      phone: $("#affiliate-phone").value.trim(),
      address: $("#affiliate-address").value.trim(),
      planId: $("#affiliate-plan").value,
      advisorId: $("#affiliate-advisor").value,
      status: $("#affiliate-status").value,
      notes: $("#affiliate-notes").value.trim(),
      updatedAt: serverTimestamp()
    };
    const id = $("#affiliate-id-hidden").value;
    if(id){
      await updateDoc(doc(colAffiliates(), id), payload);
      const idx = affiliates.findIndex(x=>x.id===id);
      affiliates[idx] = { ...affiliates[idx], ...payload };
      toast("Afiliado actualizado");
    }else{
      const ref = await addDoc(colAffiliates(), { ...payload, createdAt: serverTimestamp() });
      affiliates.unshift({ id: ref.id, ...payload });
      toast("Afiliado creado");
    }
    drawAffiliatesRows();
    closeModal("affiliate-modal");
  });

  // ===== Asesores =====
  function renderAdvisors(){
    const el = $("#asesores");
    if(currentUser.role==="afiliado"){
      el.innerHTML = `<p class="text-slate-600">No tienes acceso a esta sección.</p>`;
      return;
    }
    el.innerHTML = `
      <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
        <h2 class="text-2xl font-bold">Asesores</h2>
        <button id="add-advisor-btn" class="bg-primary-600 hover:bg-primary-700 text-white font-bold py-2 px-4 rounded-lg shadow flex items-center">
          <i data-lucide="plus" class="w-5 h-5 mr-2"></i> Nuevo Asesor
        </button>
      </div>
      <div class="bg-white rounded-xl shadow overflow-hidden">
        <table class="w-full text-sm">
          <thead class="bg-slate-50 text-slate-600 text-xs uppercase">
            <tr><th class="p-3 text-left">Nombre</th><th class="p-3 text-left">Comisión</th><th class="p-3 text-right">Acciones</th></tr>
          </thead>
          <tbody id="advisors-tbody" class="divide-y"></tbody>
        </table>
      </div>
    `;
    $("#add-advisor-btn").addEventListener("click", ()=>{
      $("#advisor-id-hidden").value=""; $("#advisor-name").value=""; $("#advisor-commission").value="";
      openModal("advisor-modal");
    });
    drawAdvisorsRows();
    lucide.createIcons();
  }
  function drawAdvisorsRows(){
    const tbody = $("#advisors-tbody");
    if(!advisors.length){ tbody.innerHTML=`<tr><td colspan="3" class="p-4 text-center text-slate-500">Sin asesores</td></tr>`; return; }
    tbody.innerHTML = advisors.map(a=>`
      <tr>
        <td class="p-3">${a.name}</td>
        <td class="p-3">${a.commissionRate}%</td>
        <td class="p-3 text-right">
          <button data-edit-adv="${a.id}" class="p-2 text-slate-500 hover:text-primary-600"><i data-lucide="pencil" class="h-4 w-4"></i></button>
          <button data-del-adv="${a.id}" class="p-2 text-slate-500 hover:text-red-600"><i data-lucide="trash-2" class="h-4 w-4"></i></button>
        </td>
      </tr>
    `).join("");
    $$('[data-edit-adv]').forEach(b=>{
      b.addEventListener('click', ()=>{
        const id=b.getAttribute('data-edit-adv'); const a=advisors.find(x=>x.id===id);
        $("#advisor-id-hidden").value=a.id; $("#advisor-name").value=a.name; $("#advisor-commission").value=a.commissionRate;
        openModal("advisor-modal");
      });
    });
    $$('[data-del-adv]').forEach(b=>{
      b.addEventListener('click', async ()=>{
        const id=b.getAttribute('data-del-adv');
        await deleteDoc(doc(colAdvisors(), id));
        advisors = advisors.filter(x=>x.id!==id);
        drawAdvisorsRows(); toast("Asesor eliminado");
      });
    });
  }
  $("#advisor-form")?.addEventListener("submit", async (e)=>{
    e.preventDefault();
    const payload = {
      name: $("#advisor-name").value.trim(),
      commissionRate: Number($("#advisor-commission").value)||0,
      updatedAt: serverTimestamp()
    };
    const id = $("#advisor-id-hidden").value;
    if(id){
      await updateDoc(doc(colAdvisors(), id), payload);
      const i=advisors.findIndex(x=>x.id===id); advisors[i]={...advisors[i],...payload};
      toast("Asesor actualizado");
    }else{
      const ref = await addDoc(colAdvisors(), { ...payload, createdAt: serverTimestamp() });
      advisors.unshift({ id:ref.id, ...payload });
      toast("Asesor creado");
    }
    drawAdvisorsRows(); closeModal("advisor-modal");
  });

  // ===== Planes =====
  function renderPlans(){
    const el = $("#planes");
    if(currentUser.role==="afiliado"){
      el.innerHTML = `<p class="text-slate-600">No tienes acceso a esta sección.</p>`;
      return;
    }
    el.innerHTML = `
      <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
        <h2 class="text-2xl font-bold">Planes de Salud</h2>
        <button id="add-plan-btn" class="bg-primary-600 hover:bg-primary-700 text-white font-bold py-2 px-4 rounded-lg shadow flex items-center">
          <i data-lucide="plus" class="w-5 h-5 mr-2"></i> Nuevo Plan
        </button>
      </div>
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6" id="plans-grid"></div>
    `;
    $("#add-plan-btn").addEventListener("click", ()=>{
      $("#plan-id-hidden").value=""; $("#plan-name").value=""; $("#plan-price").value=""; $("#plan-features").value="";
      openModal("plan-modal");
    });
    drawPlansGrid();
    lucide.createIcons();
  }
  function drawPlansGrid(){
    const grid = $("#plans-grid");
    grid.innerHTML = plans.map(p=>{
      const feats = (p.features||"").split("\n").map(f=>`<li class="flex items-start"><span class="mt-1 mr-2">•</span><span>${f}</span></li>`).join("");
      return `
        <div class="bg-white p-5 rounded-xl shadow flex flex-col">
          <div class="flex items-center justify-between">
            <h3 class="text-lg font-semibold">${p.name}</h3>
            <div class="text-primary-600 font-bold">${formatCurrency(p.price||0)}</div>
          </div>
          <ul class="mt-3 text-sm text-slate-600 space-y-1">${feats}</ul>
          <div class="mt-4 pt-4 border-t flex justify-end gap-2">
            <button data-edit-plan="${p.id}" class="px-3 py-1 rounded-lg bg-slate-100 hover:bg-slate-200 text-sm">Editar</button>
            <button data-del-plan="${p.id}" class="px-3 py-1 rounded-lg bg-red-50 hover:bg-red-100 text-red-600 text-sm">Eliminar</button>
          </div>
        </div>
      `;
    }).join("");

    $$('[data-edit-plan]').forEach(b=>{
      b.addEventListener('click', ()=>{
        const id=b.getAttribute('data-edit-plan'); const p=plans.find(x=>x.id===id);
        $("#plan-id-hidden").value=p.id; $("#plan-name").value=p.name; $("#plan-price").value=p.price; $("#plan-features").value=p.features;
        openModal("plan-modal");
      });
    });
    $$('[data-del-plan]').forEach(b=>{
      b.addEventListener('click', async ()=>{
        const id=b.getAttribute('data-del-plan');
        await deleteDoc(doc(colPlans(), id));
        plans = plans.filter(x=>x.id!==id);
        drawPlansGrid(); toast("Plan eliminado");
      });
    });
  }
  $("#plan-form")?.addEventListener("submit", async (e)=>{
    e.preventDefault();
    const payload = {
      name: $("#plan-name").value.trim(),
      price: Number($("#plan-price").value)||0,
      features: $("#plan-features").value.trim(),
      updatedAt: serverTimestamp()
    };
    const id = $("#plan-id-hidden").value;
    if(id){
      await updateDoc(doc(colPlans(), id), payload);
      const i=plans.findIndex(x=>x.id===id); plans[i]={...plans[i],...payload};
      toast("Plan actualizado");
    }else{
      const ref = await addDoc(colPlans(), { ...payload, createdAt: serverTimestamp() });
      plans.unshift({ id:ref.id, ...payload });
      toast("Plan creado");
    }
    drawPlansGrid(); closeModal("plan-modal");
  });

  // ===== Usuarios (roles de la app) =====
  function renderUsers(){
    const el = $("#usuarios");
    if(currentUser.role!=="admin"){ el.innerHTML=`<p class="text-slate-600">No tienes acceso.</p>`; return; }
    el.innerHTML = `
      <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
        <h2 class="text-2xl font-bold">Usuarios</h2>
        <button id="add-user-btn" class="bg-primary-600 hover:bg-primary-700 text-white font-bold py-2 px-4 rounded-lg shadow flex items-center">
          <i data-lucide="plus" class="w-5 h-5 mr-2"></i> Nuevo Usuario
        </button>
      </div>
      <div class="bg-white rounded-xl shadow overflow-hidden">
        <table class="w-full text-sm">
          <thead class="bg-slate-50 text-slate-600 text-xs uppercase">
            <tr><th class="text-left p-3">Email</th><th class="text-left p-3">Rol</th><th class="text-left p-3">Vinculado</th><th class="text-right p-3">Acciones</th></tr>
          </thead>
          <tbody id="users-tbody" class="divide-y"></tbody>
        </table>
      </div>
    `;
    $("#add-user-btn").addEventListener("click", ()=>{
      $("#user-id-hidden").value=""; $("#user-email").value=""; $("#user-password").value="";
      $("#user-role").value="asesor"; fillUserLinkOptions("asesor");
      openModal("user-modal");
    });
    $("#user-role").addEventListener("change", (e)=> fillUserLinkOptions(e.target.value));
    drawUsersRows();
    lucide.createIcons();
  }
  function fillUserLinkOptions(role){
    const sel = $("#user-link");
    if(role==="asesor"){
      sel.innerHTML = advisors.map(v=>`<option value="${v.id}">${v.name}</option>`).join("");
    }else if(role==="afiliado"){
      sel.innerHTML = affiliates.map(a=>`<option value="${a.id}">${a.name} (${a.document})</option>`).join("");
    }else{
      sel.innerHTML = `<option value="">—</option>`;
    }
  }
  function drawUsersRows(){
    const tbody = $("#users-tbody");
    if(!usersApp.length){ tbody.innerHTML=`<tr><td colspan="4" class="p-4 text-center text-slate-500">Sin usuarios</td></tr>`; return; }
    tbody.innerHTML = usersApp.map(u=>{
      let linked = "—";
      if(u.role==="asesor"){ const a=advisors.find(x=>x.id===u.appDataId); linked = a? a.name : "—"; }
      if(u.role==="afiliado"){ const f=affiliates.find(x=>x.id===u.appDataId); linked = f? f.name : "—"; }
      return `<tr>
        <td class="p-3">${u.email ?? "—"}</td>
        <td class="p-3">${u.role}</td>
        <td class="p-3">${linked}</td>
        <td class="p-3 text-right">
          <button data-edit-user="${u.uid}" class="p-2 text-slate-500 hover:text-primary-600"><i data-lucide="pencil" class="h-4 w-4"></i></button>
          <button data-del-user="${u.uid}" class="p-2 text-slate-500 hover:text-red-600"><i data-lucide="trash-2" class="h-4 w-4"></i></button>
        </td>
      </tr>`;
    }).join("");

    $$('[data-edit-user]').forEach(b=>{
      b.addEventListener('click', async ()=>{
        const uid=b.getAttribute('data-edit-user');
        const u = usersApp.find(x=>x.uid===uid);
        if(!u) return;
        $("#user-id-hidden").value=u.uid;
        $("#user-email").value=u.email ?? "";
        $("#user-password").value="";
        $("#user-role").value=u.role;
        fillUserLinkOptions(u.role);
        $("#user-link").value = u.appDataId || "";
        openModal("user-modal");
      });
    });
    $$('[data-del-user]').forEach(b=>{
      b.addEventListener('click', async ()=>{
        const uid=b.getAttribute('data-del-user');
        await deleteDoc(doc(colUsersApp(), uid));
        usersApp = usersApp.filter(x=>x.uid!==uid);
        drawUsersRows(); toast("Usuario eliminado (registro de app)");
      });
    });
  }
  $("#user-form")?.addEventListener("submit", async (e)=>{
    e.preventDefault();
    const uid = $("#user-id-hidden").value;
    const email = $("#user-email").value.trim();
    const role = $("#user-role").value;
    const appDataId = $("#user-link").value || null;

    if(uid){
      await updateDoc(doc(colUsersApp(), uid), { email, role, appDataId });
      const i=usersApp.findIndex(x=>x.uid===uid);
      usersApp[i]={...usersApp[i], email, role, appDataId};
      toast("Usuario actualizado");
    }else{
      const pass = $("#user-password").value.trim();
      if(!useEmu){
        toast("Para crear cuentas desde el panel usa Emulators o backend Admin SDK.", false);
      }else{
        const { user } = await createUserWithEmailAndPassword(auth, email, pass||"123456");
        await setDoc(doc(colUsersApp(), user.uid), { uid:user.uid, email, role, appDataId });
        usersApp.unshift({ uid:user.uid, email, role, appDataId });
        toast("Usuario creado");
      }
    }
    drawUsersRows(); closeModal("user-modal");
  });

  // ===== Configuración =====
  function renderConfig(){
    const el = $("#config");
    if(currentUser.role!=="admin"){ el.innerHTML=`<p class="text-slate-600">No tienes acceso.</p>`; return; }
    const smmlv = settings?.general?.SMMLV ?? "";
    const health = settings?.rates?.HEALTH ?? 12.5;
    const pension = settings?.rates?.PENSION ?? 16;

    el.innerHTML = `
      <h2 class="text-2xl font-bold mb-6">Configuración</h2>
      <form id="config-form" class="bg-white rounded-xl shadow p-6 grid grid-cols-1 sm:grid-cols-3 gap-4">
        <div>
          <label class="text-sm font-medium">SMMLV</label>
          <input id="cfg-smmlv" type="number" class="w-full p-2 border rounded-lg" value="${smmlv}"/>
        </div>
        <div>
          <label class="text-sm font-medium">% Salud</label>
          <input id="cfg-health" type="number" step="0.1" class="w-full p-2 border rounded-lg" value="${health}"/>
        </div>
        <div>
          <label class="text-sm font-medium">% Pensión</label>
          <input id="cfg-pension" type="number" step="0.1" class="w-full p-2 border rounded-lg" value="${pension}"/>
        </div>
        <div class="sm:col-span-3 pt-4 border-t flex justify-end">
          <button class="bg-primary-600 hover:bg-primary-700 text-white font-bold py-2 px-6 rounded-lg">Guardar</button>
        </div>
      </form>
    `;

    $("#config-form").addEventListener("submit", async (e)=>{
      e.preventDefault();
      const general = { SMMLV: Number($("#cfg-smmlv").value)||0, updatedAt: serverTimestamp() };
      const rates   = { HEALTH: Number($("#cfg-health").value)||0, PENSION: Number($("#cfg-pension").value)||0, updatedAt: serverTimestamp() };
      await setDoc(doc(colSettings(), "general"), general);
      await setDoc(doc(colSettings(), "rates"), rates);
      settings = { ...settings, general, rates };
      toast("Configuración guardada");
    });
  }

  // ===== Modales (cerrar) =====
  $$('[data-close]').forEach(btn=>{
    btn.addEventListener('click', ()=> closeModal(btn.getAttribute('data-close')));
  });
  window.addEventListener('keydown', e=>{
    if(e.key==="Escape"){ ["affiliate-modal","advisor-modal","plan-modal","user-modal"].forEach(closeModal); }
  });

  // ===== Helpers =====
  function formatCurrency(n, locale="es-CO", currency="COP"){
    try{ return new Intl.NumberFormat(locale, { style:"currency", currency, maximumFractionDigits:0 }).format(n||0); }
    catch{ return `$${(n||0).toLocaleString()}`; }
  }
  function capitalize(s){ return (s||"").charAt(0).toUpperCase()+ (s||"").slice(1); }

  // ===== Render inicial =====
  lucide.createIcons();

</script>
</body>
</html>
